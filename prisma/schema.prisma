generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  ADMIN
  BARBER
  RECEPTION
}

enum AppointmentStatus {
  CONFIRMED
  CANCELLED
  NO_SHOW
  DONE
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum CommissionType {
  PERCENT
  FIXED
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String?  @unique
  timezone  String   @default("America/Sao_Paulo")
  isActive  Boolean  @default(true)
  address   String?
  phone     String?
  createdAt DateTime @default(now())

  memberships Membership[]
  professionals Professional[]
  customers Customer[]
  services Service[]
  appointments Appointment[]
  transactions Transaction[]
  commissions Commission[]
  loyaltyLedger LoyaltyLedger[]
  whatsappMessages WhatsappMessage[]
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  isSuperAdmin Boolean  @default(false)
  createdAt    DateTime @default(now())

  memberships Membership[]
  professionals Professional[]
}

model Membership {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  role      Role     @default(ADMIN)
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([userId])
  @@index([tenantId])
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model Professional {
  id             String         @id @default(cuid())
  tenantId       String
  userId         String?
  name           String
  phone          String?        // WhatsApp
  isActive       Boolean        @default(true)
  commissionType CommissionType @default(PERCENT)
  commissionValue Int           @default(50)
  createdAt      DateTime       @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  appointments Appointment[]
  commissions  Commission[]
  availability ProfessionalAvailability[]

  @@index([tenantId, isActive])
  @@index([tenantId, userId])
}

model ProfessionalAvailability {
  id             String      @id @default(cuid())
  professionalId String
  dayOfWeek      DayOfWeek
  startTime      String      // Format: "HH:mm"
  endTime        String      // Format: "HH:mm"
  breakStart     String?     // Format: "HH:mm"
  breakEnd       String?     // Format: "HH:mm"
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([professionalId, dayOfWeek])
  @@index([professionalId])
}

model Customer {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  phone     String
  notes     String?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  loyaltyLedger LoyaltyLedger[]

  @@unique([tenantId, phone])
  @@index([tenantId, createdAt])
}

model Service {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  durationMin Int
  priceCents  Int
  isActive    Boolean  @default(true)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@index([tenantId, isActive])
}

model Appointment {
  id             String            @id @default(cuid())
  tenantId       String
  customerId     String
  professionalId String
  serviceId      String
  startAt        DateTime
  endAt          DateTime
  status         AppointmentStatus @default(CONFIRMED)
  source         String            @default("internal")
  notes          String?
  createdAt      DateTime          @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer     Customer     @relation(fields: [customerId], references: [id], onDelete: Restrict)
  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Restrict)
  service      Service      @relation(fields: [serviceId], references: [id], onDelete: Restrict)

  transactions Transaction[]
  commissions  Commission[]

  @@index([tenantId, startAt])
  @@index([tenantId, professionalId, startAt])
  @@index([tenantId, customerId, startAt])
}

model Transaction {
  id           String          @id @default(cuid())
  tenantId     String
  occurredAt   DateTime
  type         TransactionType
  amountCents  Int
  method       String?
  category     String?
  appointmentId String?
  createdAt    DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  @@index([tenantId, occurredAt])
  @@index([tenantId, type, occurredAt])
}

model Commission {
  id             String   @id @default(cuid())
  tenantId       String
  appointmentId  String
  professionalId String
  amountCents    Int
  calculatedAt   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([tenantId, appointmentId, professionalId])
  @@index([tenantId, professionalId, calculatedAt])
}

model LoyaltyLedger {
  id          String   @id @default(cuid())
  tenantId    String
  customerId  String
  pointsDelta Int
  reason      String
  createdAt   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([tenantId, customerId, createdAt])
}

model WhatsappMessage {
  id        String   @id @default(cuid())
  tenantId  String
  toPhone   String
  template  String
  payload   Json
  status    String   @default("queued")
  error     String?
  createdAt DateTime @default(now())
  sentAt    DateTime?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status, createdAt])
}
